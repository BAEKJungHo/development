# 메뉴 통계

찾아보고 정리해보니 메뉴 통계를 구현하는데 있어 필요한 기술은 `Spring Quartz + Spring Batch + DB Partitioning + 커버링 인덱스` 일 거같음.
  
- 메뉴 통계 관리
    - 관리자 메뉴 통계 관리
    - 사용자 메뉴 통계 관리

- 관리자랑 사용자 메뉴 통계를 분리하려는 이유
    - 목적 자체가 다르다
        - 관리자 메뉴 통계는 관리자가 어떤 메뉴를 클릭했는지에 대한 `이력관리` 가 핵심.
        - 사용자 메뉴 통계는 여러 사용자 들이 어떤 메뉴를 즐겨 찾는지에 대한 `통계` 가 핵심.
    - 메뉴 구성도 다르다
        - 관리자와 사용자 메뉴 구성도 다르며, 사용자 메뉴가 훨씬 많다.

- 테이블 1개
    - TYPE 값으로 구분 
        - 관리자 : A
        - 사용자 : U
    - 얼만큼 쌓였을때 백업을 할껀지에 대한 기준같은것도 필요할 듯
- 테이블 2개
    - 만약 백업 기준이라던지 관리자 사용자가 다른경우 테이블을 2개로 나누는게 편할 수도 있을거 같음

- 고려해야할 사항
    - 한 사람당 여러 메뉴를 누를 수 있기 때문에, 사용자 메뉴 통계의 경우 하루에 몇 천건이 쌓일 수 도 있다.
    - 관리자는 몇천건 까지는 아닐거 같음

- 차트를 써야 할까?
    - 차트 목적은 한눈에 보기 위함인데, 사용자 메뉴가 엄청 많으면, 막대 차트나 파이차트 등 모든 메뉴를 한눈에 보기에는 어려울거같음
    - 어차피 사람들의 관심은 사용자가 제일 관심있어야하는 상위 메뉴 몇개와, 하위 메뉴 몇개 정도라고 생각함
    - 만약, 꼭 차트를 쓰고싶다면, 상위 몇개와 하위 몇개 메뉴를 선정해서 막대 차트를 이용하는게 낫다고 생각함

- 그렇다면 어떻게 해야할까?
    - 처음에 사용자 혹은 관리자 메뉴 통계 관리를 누르면 이력이 쌓아져있는 리스트 페이지를 보여 준다.
    - `<div class="controls">` 이 부분에 `통계 확인` 이라는 버튼을 누른다.
    - 퍼센트(%) 가 높은 순서대로 메뉴 이름 과 퍼센트(%) 를 보여준다.
    - 메뉴가 너무 많은경우 아래까지 스크롤을 내리기 힘들거같으니, `정렬 순서 변경을 위한 버튼`을 추가해준다.
        - 처음에 default 는 내림차순으로 보여주고 버튼 이름은 오름차순 일것
        - 오름차순 버튼을 누르면, 버튼 이름을 내림차순으로 변경

- 엑셀 다운로드도 필요할까?
    - 기존 권한이력이나 접속이력 관리 처럼 날짜 검색조건 줘서 해당 날짜에 포함되는 애들만 엑셀다운로드 가능하도록 구현가능

- 일별, 월별, 년도별 통계
    - 특히 사용자 메뉴 통계의 경우 `년도별 통계(퍼센트)` 확인과 `월별 통계(퍼센트)` 확인이 필요할 거같음
        - 예를들어 하루에 1000 명 이 웹 사이트에 접속하고, 한 사람당 5개의 메뉴를 클릭해본다 하면, 하루당 5천개의 데이터가 쌓임
            - 1달이면 15만개
            - 1년이면 130만개
            - 사이트 마다 다르겠지만 1년에 쌓이는 데이터 개수가 100만이라 치면, 1년마다 해도 괜찮지 않을까 하는 생각
        - 리스트 페이지에서 통계 확인 버튼 누르면 해당 페이지로 이동하고 거기서 년도별 통계와 월별 통계 확인을 위한 날짜 조건이 필요할거같음
            - 특정 년도 월 ~ 특정 년도 월 까지의 통계도 구할 수 있게
                - 근데 그러면 테이블 백업한다는 가정하에 년도가 1년 차이날 때마다 조인이 1개씩 동적으로 늘어나는 기이한 현상이 생길거같음...
                - 테이블 백업을 주기적으로 안하던지 아니면, 위 조건을 빼던지 해야할거같음
        - 근데 데이터가 엄청 많아서 특정 검색조건을 주지 않고 엑셀다운로드를 하게 되면, 직접 그리는 방식이더라도 오래걸릴거 같음.
        - `https://m.blog.naver.com/tmondev/221388780914` 참고
        - SXSSF 기준으로 데이터 1만건 당 2.097 걸린다고 했음 100만이면 200초.. 
        - 1만건 이상일때 JXLS 사용하면 OOM error 발생하여 서버가 다운될 수 도 있음
 
- 데이터 많은 문제를 해결하기 위한 전략 Spring Quartz 와 Spring Batch
    - `https://jojoldu.tistory.com/324`
    - 많은 거래가 이루어지는 커머스 사이트의 경우 하루 거래건이 50만 ~ 100만 이고 한달이면 5천만 ~ 1억 가까이 된다고함
        - 그러면 이런 회사들은 DB 백업 주기가 얼마큼 될까 궁금함..
        - 100만당 일거 같진 않다고 생각 그러면 1년이면 백업테이블 포함해서 365개나 되니까..
    - 이런 경우에 Spring Quartz 와 Spring Batch 를 사용한다고 함
    - 대신 Spring Batch 를 사용하는 경우 실시간 집계는 불가능함
    - 만약 Spring Batch 사용하려는 경우 매일 새벽 전날 일일 매출 집계 데이터를 만들고, 외부 요청이 올 경우 미리 만들어둔 집계 데이터를 바로 전달하는 방식을 취해야 할듯

- 데이터 용량이 많으므로 `DB Partitioning` 디비 파티셔닝이라는 기법을 찾아서 하면 성능 개선에 도움이 될거같음
    - `https://gmlwjd9405.github.io/2018/09/24/db-partitioning.html`
    - 큰 table이나 index를, 관리하기 쉬운 partition이라는 작은 단위로 물리적으로 분할하는 것을 의미한다.
        - 물리적인 데이터 분할이 있더라도, DB에 접근하는 application의 입장에서는 이를 인식하지 못한다.
    - partition 별로 백업이 가능함
    - full scan 에서 데이터 access 범위를 줄여 성능 향상
    - 필요한 데이터만 빠르게 조회 가능
    - 많은 INSERT가 있는 OLTP 시스템에서 INSERT 작업을 작은 단위인 partition들로 분산시켜 경합을 줄인다.
    - 단점
        - table 간 join 비용이 증가
        - table 과 index 를 별도로 파티셔닝 할 수 없다. 같이해야함

- 그러면 리스트 페이지 접근할때 10년치 데이터가 db에 쌓여있다고 가정 약 1천만건
    - `https://tipland.tistory.com/55`
    - 일반 쿼리로 조회할경우 30 초 정도 걸린다고함
    - 커버링 인덱스를 이용한 조회 할 경우 0.16 초 정도 걸린다고함

- 참고
    - 인덱스 : https://jojoldu.tistory.com/243
    - 커버링 인덱스 : https://jojoldu.tistory.com/476
